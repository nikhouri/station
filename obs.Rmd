---
title: "Emmer Green Weather Station"
author: "nik@nikhouri.com"
output:
  html_document:
    fig_width: 10
    fig_height: 4
    toc: TRUE
---
Generated `r Sys.time()`

# Summary
```{r, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE, }
library(knitr)

# RDB query
url <- 'http://localhost:5011/.csv?'
query <- 'pctile:{ y (100 xrank y:asc y) bin x}; select last time, now:last data, low:pctile[5;data], median:med data, high:pctile[95;data] by host,sym,units from obs where host=`garden'
uquery <- URLencode(query)
dfn <- read.csv(paste0(url,uquery),stringsAsFactors=FALSE)
dfn$time = as.POSIXct(dfn$time,format='0D%H:%M:%S',tz='UTC')

knitr::kable(dfn,row.names=TRUE)
```

# Today's Charts

```{r, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE, }
library(ggplot2)

# RDB query
url <- 'http://localhost:5011/.csv?'
query <- 'pctile:{ y (100 xrank y:asc y) bin x}; select low:pctile[5;data], median:med data, high:pctile[95;data] by 10 xbar time.minute,sym from obs where host=`garden'
uquery <- URLencode(query)
dfr <- read.csv(paste0(url,uquery),stringsAsFactors=FALSE)
dfr$time = as.POSIXct(dfr$minute,format='%H:%M',tz='UTC')

# Tol Vibrant colour map
tolvibrant <- c("#EE3377", "#EE7733", "#0077BB", "#009988", "#33BBEE", "#CC3311", "#BBBBBB")

# Number format function
numfmt <- function(x) format(x, big.mark=" ", decimal.mark=".", scientific=FALSE)

# Temperature chart
ggplot(dfr[dfr$sym=='temperature',]) +
  # Data series
  geom_line(aes(x=time,y=median,color=sym), size=1) +
  geom_ribbon(aes(x=time,ymin=low,ymax=high,fill=sym), alpha=0.2) + 
  # Axis scales and colour scales
  scale_y_continuous(label=numfmt) +
  scale_color_discrete(type=tolvibrant) +
  scale_fill_discrete(type=tolvibrant) +
  # Plot labels
  labs(title="Air Temperature",
       x=NULL, y="°C",
       subtitle = "Today, 10 minute medians and 5th/95th percentiles",
       caption="Source: observatory db",
       color=NULL) +
  # Themeing & fonts
  theme_light() +
  theme(legend.position="hidden",
        text=element_text(size=15, family="Fira Sans Extra Condensed"),
        plot.title=element_text(family="Fira Sans Extra Condensed Medium"),
        plot.caption=element_text(color="#666666"))

# Humidity chart
ggplot(dfr[dfr$sym=='humidity',]) +
  # Data series
  geom_line(aes(x=time,y=median,color=sym), size=1) +
  geom_ribbon(aes(x=time,ymin=low,ymax=high,fill=sym), alpha=0.2) + 
  # Axis scales and colour scales
  scale_y_continuous(label=numfmt) +
  scale_color_discrete(type=tolvibrant) +
  scale_fill_discrete(type=tolvibrant) +
  # Plot labels
  labs(title="Humidity",
       x=NULL, y="Percent",
       subtitle = "Today, 10 minute medians and 5th/95th percentiles",
       caption="Source: observatory db",
       color=NULL) +
  # Themeing & fonts
  theme_light() +
  theme(legend.position="hidden",
        text=element_text(size=15, family="Fira Sans Extra Condensed"),
        plot.title=element_text(family="Fira Sans Extra Condensed Medium"),
        plot.caption=element_text(color="#666666"))

# Air pressure chart
ggplot(dfr[dfr$sym=='pressure',]) +
  # Data series
  geom_line(aes(x=time,y=median,color=sym), size=1) +
  geom_ribbon(aes(x=time,ymin=low,ymax=high,fill=sym), alpha=0.2) + 
  # Axis scales and colour scales
  scale_y_continuous(label=numfmt) +
  scale_color_discrete(type=tolvibrant) +
  scale_fill_discrete(type=tolvibrant) +
  # Plot labels
  labs(title="Air Pressure",
       x=NULL, y="hPa",
       subtitle = "Today, 10 minute medians and 5th/95th percentiles",
       caption="Source: observatory db",
       color=NULL) +
  # Themeing & fonts
  theme_light() +
  theme(legend.position="hidden",
        text=element_text(size=15, family="Fira Sans Extra Condensed"),
        plot.title=element_text(family="Fira Sans Extra Condensed Medium"),
        plot.caption=element_text(color="#666666"))
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE, fig.width=10, fig.height=6}
ggplot(dfr[dfr$sym %in% c('cpu','cputemp','mem'),]) +
  # Data series
  geom_line(aes(x=time,y=median,color=sym), size=1) +
  geom_ribbon(aes(x=time,ymin=low,ymax=high,fill=sym), alpha=0.2) + 
  # Axis scales and colour scales
  scale_y_continuous(label=numfmt)+
  scale_color_discrete(type=tolvibrant) +
  scale_fill_discrete(type=tolvibrant) +
  # Plot labels
  labs(title="Observatory Diagnostics",
       x=NULL, y="CPU %, Mem %, CPU °C",
       subtitle = "CPU %, Mem %, CPU °C",
       caption="Source: observatory db",
       color=NULL,fill=NULL) +
  # Themeing & fonts
  theme_light() +
  theme(legend.position="top",
        text=element_text(size=15, family="Fira Sans Extra Condensed"),
        plot.title=element_text(family="Fira Sans Extra Condensed Medium"),
        plot.caption=element_text(color="#666666"))
```
